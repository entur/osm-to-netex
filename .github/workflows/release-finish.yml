name: Release Finish (Gitflow)

on:
  workflow_dispatch:
    inputs:
      release_branch:
        description: 'Release branch to finish (e.g., release/2.0.16)'
        required: true
        type: string
      next_version_increment:
        description: 'Next version increment type for master'
        required: false
        type: choice
        default: 'patch'
        options:
          - major
          - minor
          - patch
      next_version:
        description: 'Or specify exact next version for master (e.g., 2.1.0-SNAPSHOT)'
        required: false
        type: string

jobs:
  get-release-version:
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_branch }}
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: liberica

      - name: Get release version
        id: get_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          # Remove -SNAPSHOT if present
          VERSION="${VERSION%-SNAPSHOT}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

  create-tag:
    name: Create release tag
    needs: get-release-version
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          VERSION="${{ needs.get-release-version.outputs.version }}"
          TAG="v${VERSION}"

          echo "Creating tag: $TAG from branch ${{ inputs.release_branch }}"
          git tag -a "$TAG" -m "Release $VERSION"
          git push origin "$TAG"

  publish-release:
    name: Publish to Maven Central
    needs: [get-release-version, create-tag]
    uses: entur/gha-maven-central/.github/workflows/maven-publish.yml@v1
    with:
      snapshot: false
      push_to_repo: false
      java_version: 21
      git_ref: v${{ needs.get-release-version.outputs.version }}
      next_version: ${{ needs.get-release-version.outputs.version }}
    secrets: inherit

  update-master:
    name: Update master to next SNAPSHOT version
    needs: [get-release-version, publish-release]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: liberica

      - name: Calculate next development version
        id: next_version
        run: |
          chmod +x .github/scripts/next-version.sh

          CURRENT_VERSION="${{ needs.get-release-version.outputs.version }}"

          # Use custom version if provided, otherwise increment
          if [ -n "${{ inputs.next_version }}" ]; then
            NEXT_VERSION="${{ inputs.next_version }}"
            # Ensure it has -SNAPSHOT
            if [[ ! "$NEXT_VERSION" =~ -SNAPSHOT$ ]]; then
              NEXT_VERSION="${NEXT_VERSION}-SNAPSHOT"
            fi
          else
            INCREMENT_TYPE="${{ inputs.next_version_increment }}"
            NEXT_VERSION=$(.github/scripts/next-version.sh "$CURRENT_VERSION" "$INCREMENT_TYPE")
          fi

          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Next development version: $NEXT_VERSION"

      - name: Update master version
        run: |
          NEXT_VERSION="${{ steps.next_version.outputs.next_version }}"
          echo "Updating master to: $NEXT_VERSION"

          mvn -B versions:set -DnewVersion="$NEXT_VERSION" -DgenerateBackupPoms=false -DprocessAllModules=true

          git add '*/pom.xml' pom.xml
          git commit -m "chore: prepare for next development iteration $NEXT_VERSION [skip ci]"
          git push origin master

      - name: Delete release branch
        continue-on-error: true
        run: |
          RELEASE_BRANCH="${{ inputs.release_branch }}"
          echo "Deleting release branch: $RELEASE_BRANCH"
          git push origin --delete "$RELEASE_BRANCH" || echo "Branch already deleted"

      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Release Finished

          - **Released Version:** ${{ needs.get-release-version.outputs.version }}
          - **Maven Central (Library):** https://central.sonatype.com/artifact/io.entur/osm-to-netex-beta/${{ needs.get-release-version.outputs.version }}
          - **Maven Central (CLI):** https://central.sonatype.com/artifact/io.entur/osm-to-netex-beta-cli/${{ needs.get-release-version.outputs.version }}
          - **Git Tag:** \`v${{ needs.get-release-version.outputs.version }}\`
          - **Next Development Version (master):** ${{ steps.next_version.outputs.next_version }}
          - **Release Branch:** Deleted

          The release has been published to Maven Central and master branch has been updated to the next development version.
          EOF