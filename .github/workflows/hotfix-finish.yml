name: Hotfix Finish (Gitflow)

on:
  workflow_dispatch:
    inputs:
      hotfix_branch:
        description: 'Hotfix branch to finish (e.g., hotfix/2.0.16.1)'
        required: true
        type: string
      merge_to_master:
        description: 'Cherry-pick hotfix commits to master'
        required: false
        type: boolean
        default: true

jobs:
  get-hotfix-version:
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.hotfix_branch }}
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: liberica

      - name: Get hotfix version
        id: get_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          # Remove -SNAPSHOT if present
          VERSION="${VERSION%-SNAPSHOT}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Hotfix version: $VERSION"

  create-tag:
    name: Create hotfix tag
    needs: get-hotfix-version
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.hotfix_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          VERSION="${{ needs.get-hotfix-version.outputs.version }}"
          TAG="v${VERSION}"

          echo "Creating tag: $TAG from branch ${{ inputs.hotfix_branch }}"
          git tag -a "$TAG" -m "Hotfix $VERSION"
          git push origin "$TAG"

  publish-hotfix:
    name: Publish to Maven Central
    needs: [get-hotfix-version, create-tag]
    uses: entur/gha-maven-central/.github/workflows/maven-publish.yml@v1
    with:
      snapshot: false
      push_to_repo: false
      java_version: 21
      git_ref: v${{ needs.get-hotfix-version.outputs.version }}
      next_version: ${{ needs.get-hotfix-version.outputs.version }}
    secrets: inherit

  merge-to-master:
    name: Cherry-pick hotfix to master
    needs: [get-hotfix-version, publish-hotfix]
    if: inputs.merge_to_master == true
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Cherry-pick hotfix commits
        run: |
          HOTFIX_BRANCH="${{ inputs.hotfix_branch }}"
          echo "Cherry-picking commits from $HOTFIX_BRANCH to master"

          # Get the base commit (where hotfix branched from)
          git fetch origin "$HOTFIX_BRANCH"

          # Find all commits in the hotfix branch
          HOTFIX_COMMITS=$(git log --reverse --pretty=format:"%H" origin/$HOTFIX_BRANCH --not $(git merge-base origin/master origin/$HOTFIX_BRANCH))

          # Cherry-pick each commit
          for commit in $HOTFIX_COMMITS; do
            echo "Cherry-picking commit: $commit"
            git cherry-pick "$commit" || {
              echo "::warning::Cherry-pick conflict on commit $commit. Resolve manually."
              git cherry-pick --abort
              exit 1
            }
          done

      - name: Push to master
        run: |
          git push origin master

      - name: Delete hotfix branch
        continue-on-error: true
        run: |
          HOTFIX_BRANCH="${{ inputs.hotfix_branch }}"
          echo "Deleting hotfix branch: $HOTFIX_BRANCH"
          git push origin --delete "$HOTFIX_BRANCH" || echo "Branch already deleted"

      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Hotfix Released

          - **Hotfix Version:** ${{ needs.get-hotfix-version.outputs.version }}
          - **Maven Central (Library):** https://central.sonatype.com/artifact/io.entur/osm-to-netex-beta/${{ needs.get-hotfix-version.outputs.version }}
          - **Maven Central (CLI):** https://central.sonatype.com/artifact/io.entur/osm-to-netex-beta-cli/${{ needs.get-hotfix-version.outputs.version }}
          - **Git Tag:** \`v${{ needs.get-hotfix-version.outputs.version }}\`
          - **Hotfix Branch:** Deleted
          - **Merged to Master:** ${{ inputs.merge_to_master }}

          The hotfix has been published to Maven Central.
          EOF