name: Release Start (Gitflow)

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., 2.0.16). Leave empty to auto-detect from develop.'
        required: false
        type: string
      base_branch:
        description: 'Base branch to create release from'
        required: false
        type: string
        default: 'master'

jobs:
  release-start:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: liberica

      - name: Get current version
        id: get_version
        run: |
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate release version
        id: calc_version
        run: |
          CURRENT_VERSION="${{ steps.get_version.outputs.current_version }}"

          if [ -n "${{ inputs.release_version }}" ]; then
            RELEASE_VERSION="${{ inputs.release_version }}"
          else
            # Remove -SNAPSHOT suffix
            RELEASE_VERSION="${CURRENT_VERSION%-SNAPSHOT}"
          fi

          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "Release version will be: $RELEASE_VERSION"

      - name: Create release branch
        id: create_branch
        run: |
          RELEASE_VERSION="${{ steps.calc_version.outputs.release_version }}"
          BRANCH_NAME="release/${RELEASE_VERSION}"

          echo "Creating branch: $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Update version to release version
        run: |
          RELEASE_VERSION="${{ steps.calc_version.outputs.release_version }}"
          echo "Updating version to: $RELEASE_VERSION"

          mvn -B versions:set -DnewVersion="$RELEASE_VERSION" -DgenerateBackupPoms=false -DprocessAllModules=true

          git add '*/pom.xml' pom.xml
          git commit -m "chore: prepare release $RELEASE_VERSION"

      - name: Push release branch
        run: |
          BRANCH_NAME="${{ steps.create_branch.outputs.branch_name }}"
          git push origin "$BRANCH_NAME"

      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Release Started

          - **Release Version:** ${{ steps.calc_version.outputs.release_version }}
          - **Release Branch:** \`${{ steps.create_branch.outputs.branch_name }}\`
          - **Base Branch:** \`${{ inputs.base_branch }}\`

          ### Next Steps

          1. Review and test the release branch
          2. Make any final adjustments if needed
          3. When ready, merge the release branch to \`master\` to trigger the release
          4. The release will be automatically published to Maven Central
          5. The release branch will be merged back to \`develop\` automatically
          EOF